---
title: "A Quick Introduction to iNEXT.Beta3D"
author: "Y. S. Kao, Z. C. Szu Tu, and Anne Chao"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    vignette: >
      %\VignetteIndexEntry{A Quick Introduction to iNEXT.Beta3D}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", 
                      fig.retina = 2,
                      fig.align = 'center',
                      fig.width = 7, fig.height = 5,
                      warning = FALSE, message = FALSE)
options("width"=200)
library(iNEXT.Beta3D)
```

**`iNEXT-beta`** (iNterpolation and EXTrapolation for beta diversity) is an R package 
aiming to calculating beta diversity for multiple assemblages.
Here we provide a quick introduction demonstrating how to run iNEXT-beta, and showing four types of turnover transformation. 

Here are two functions we provide in this package : 

- **iNEXT_beta** : Calculating gamma, alpha, beta diversity and dissimilarity-turnover for taxonomic, phylogenetic and functional diversity at specified sample coverage.

- **ggiNEXT_beta** : Visualizing the output of iNEXT_beta.


```{r eval=FALSE}
## install iNEXT.Beta3D package from CRAN
install.packages("iNEXT.Beta3D")
## install the latest version from github
install.packages('devtools')
library(devtools)
install_github('AnneChao/iNEXT.Beta3D')
## import packages
library(iNEXT.Beta3D)
```



## MAIN FUNCTION: iNEXT_beta()

We first describe the main function `iNEXT_beta()` with default arguments: 

```{r eval=FALSE}
iNEXTBeta3D(data, diversity = "TD", q = c(0, 1, 2), datatype = "abundance",
            base = "coverage", level = NULL, nboot = 20, conf = 0.95,
            PDtree = NULL, PDreftime = NULL, PDtype = "meanPD",
            FDdistM = NULL, FDtype = "AUC", FDtau = NULL, FDcut_number = 30)
```


The arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text. This main function computes gamma, alpha and beta diversity estimates of order q at specified sample coverage and measure of diversity. 
  
<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>data</code></td>
<td align="left">
(a) For <code>datatype = "abundance"</code>, data can be input as a <code>matrix/data.frame</code> (species by assemblages), or a list of <code>matrices/data.frames</code>, each matrix represents species-by-assemblages abundance matrix; see Note 1 for examples. \cr
(b) For <code>datatype = "incidence_raw"</code>, data can be input as a list of <code>matrices/data.frames</code>, each matrix represents species-by-sampling units; see Note 2 for an example.</td>

</tr>
<tr class="even">
<td align="center"><code>diversity</code></td>
<td align="left">selection of diversity type: **'TD'** = Taxonomic diversity, **'PD'** = Phylogenetic diversity, and **'FD'** = Functional diversity.</td>

</tr>
<tr class="odd">
<td align="center"><code>q</code></td>
<td align="left">a numerical vector specifying the diversity orders. Default is c(0, 1, 2).</td>

</tr>
<tr class="even">
<td align="center"><code>datatype</code></td>
<td align="left">data type of input data: individual-based abundance data (<code>datatype = "abundance"</code>) or species by sampling-units incidence matrix (<code>datatype = "incidence_raw"</code>) with all entries being 0 (non-detection) or 1 (detection).</td>

</tr>
<tr class="odd">
<td align="center"><code>base</code></td>
<td align="left">Sample-sized-based rarefaction and extrapolation for gamma and alpha diversity (<code>base = "size"</code>) or coverage-based rarefaction and extrapolation for gamma, alpha and beta diversity (<code>base = "coverage"</code>). Default is base = "coverage".</td>

</tr>
<tr class="even">
<td align="center"><code>level</code></td>
<td align="left">A numerical vector specifying the particular value of sample coverage (between 0 and 1 when <code>base = "coverage"</code>) or sample size (<code>base = "size"</code>). level = 1 (base = "coverage") means complete coverage  \cr
(the corresponding diversity represents asymptotic diversity). \cr
If <code>base = "size"</code> and <code>level = NULL</code>, then this function computes the gamma and alpha diversity estimates up to double the reference sample size.  \cr
If <code>base = "coverage"</code> and <code>level = NULL</code>, then this function computes the gamma and alpha diversity estimates up to one (for q = 1, 2) or up to the coverage of double the reference sample size (for q = 0);
the corresponding beta diversity is computed up to the same maximum coverage as the alpha diversity.</td>

</tr>
<tr class="odd">
<td align="center"><code>nboot</code></td>
<td align="left">a positive integer specifying the number of bootstrap replications when assessing sampling uncertainty and constructing confidence intervals. Bootstrap replications are generally time consuming. Enter <code>0</code> to skip the bootstrap procedures. Default is <code>20</code>. If more accurate results are required, set <code>nboot = 100</code> (or <code>200</code>).</td>

</tr>
<tr class="even">
<td align="center"><code>conf</code></td>
<td align="left">a positive number < 1 specifying the level of confidence interval. Default is <code>0.95</code>.</td>

</tr>
<tr class="odd">
<td align="center"><code>PDtree</code></td>
<td align="left">a <code>phylo</code>(required only when **8diversity = "PD"**), a phylogenetic tree in Newick format for all observed species in the pooled assemblage.</td>

</tr>
<tr class="even">
<td align="center"><code>PDreftime</code></td>
<td align="left">(required only when **diversity = "PD"**), a vector of numerical values specifying reference times for PD. Default is NULL (i.e., the age of the root of PDtree).</td>

</tr>
<tr class="odd">
<td align="center"><code>PDtype</code></td>
<td align="left">(required only when **diversity = "PD"**), select PD type: <code>PDtype = "PD"</code> (effective total branch length) or <code>PDtype = "meanPD"</code> (effective number of equally divergent lineages). Default is <code>"meanPD"</code>, where <code>meanPD = PD/tree depth</code>.</td>

</tr>
<tr class="even">
<td align="center"><code>FDdistM</code></td>
<td align="left">	
(required only when **diversity = "FD"**), a species pairwise distance matrix for all species in the pooled assemblage.</td>

</tr>
<tr class="odd">
<td align="center"><code>FDtype</code></td>
<td align="left">(required only when **diversity = "FD"**), select FD type: <code>FDtype = "tau_value"</code> for FD under specified threshold values, or <code>FDtype = "AUC"</code> (area under the curve of tau-profile) for an overall FD which integrates all threshold values between zero and one. Default is <code>"AUC"</code>.</td>


</tr>
<tr class="even">
<td align="center"><code>FDtau</code></td>
<td align="left">(required only when **diversity = "FD"** and <code>FDtype = "tau_value"</code>), a numerical vector between 0 and 1 specifying tau value (threshold level). If <code>NULL</code> (default), then threshold is set to be the mean distance between any two individuals randomly selected from the pooled assemblage (i.e., quadratic entropy).</td>

</tr>
<tr class="odd">
<td align="center"><code>FDcut_number</code></td>
<td align="left">(required only when **diversity = "FD"** and <code>FDtype = "AUC"</code>), a numeric number to split zero to one into several equal-spaced length. Default is <code>30</code>.</td>


</tbody>
</table>


This function returns an `"iNEXT_beta"` object which can be further used to make plots 
using the function `ggiNEXT_beta()` to be described below. 

## DATA FORMAT/INFORMATION
Two types of data are supported:

1. Individual‐based abundance data (`data_type="abundance"`):
Input data for each assemblage include samples species abundances in an empirical sample of n individuals (“reference sample”). When there are N assemblages, input data consist of an S by N abundance matrix ; For M regions consisting N assemblages, input data should be M lists of S by N abundance matrix.

2. Sampling‐unit‐based incidence data (`data_type="incidence_raw"` ):
Input data for a reference sample consist of a species‐by‐sampling‐unit matrix;
The number of sampling units for each assemblages in a region should be the same.
For M regions consisting N assemblages, input data should be M list of N list of species‐by‐sampling‐unit matrix.

## Rarefaction/Extrapolation Via Examples

Two data sets ( Plant under different treatments for abundance and incidence data ) are included in iNEXT_beta package. The plant data consist of abundance and incidence data under two different treatments (“Exclosure” and “Control”) from 2015 to 2020. For these data, the following commands display how to compute taxonomic, phylogenetic and functional dissimilarities at specified sample coverage for abundance and incidence data respectively.

```{r eval=FALSE}
data("beetle_abu")
data("beetle_inc")
data("beetle_tree")
data("beetle_distM")

# Taxonomic diversity
Abu_td_out = iNEXTBeta3D(data = beetle_abu, diversity = 'TD', datatype = "abundance", 
                         nboot = 20)

Inc_td_out = iNEXTBeta3D(data = beetle_inc, diversity = 'TD', datatype = "incidence_raw",
                         nboot = 20)


# Phylogenetic diversity
Abu_pd_out = iNEXTBeta3D(data = beetle_abu, diversity = 'PD', datatype = "abundance", 
                         nboot = 20, PDtree = tree)

Inc_pd_out = iNEXTBeta3D(data = beetle_inc, diversity = 'PD', datatype = "incidence_raw", 
                         nboot = 20, PDtree = tree)


# Functional diversity - single threshold
Abu_fd_out = iNEXTBeta3D(data = beetle_abu, diversity = 'FD', datatype = "abundance",  nboot = 20,
                         FDdistM = disM, FDtype = 'single', FDtau = 0.5)

Inc_fd_out = iNEXTBeta3D(data = beetle_inc, diversity = 'FD', datatype = "incidence_raw", nboot = 20,
                         FDdistM = disM, FDtype = 'single', FDtau = 0.5)


# Functional diversity - area under curve
Abu_fd_out = iNEXTBeta3D(data = beetle_abu, diversity = 'FD', datatype = "abundance", nboot = 20,
                         FDdistM = disM, FDtype = 'AUC')

Inc_fd_out = iNEXTBeta3D(data = beetle_inc, diversity = 'FD', datatype = "incidence_raw", nboot = 20,
                         FDdistM = disM, FDtype = 'AUC')

```

The `iNEXT_beta()` function returns the `"iNEXT_beta"` object including seven data frames for each regions : 

- gamma 
- alpha 
- beta
- C ( Sorensen-type non-overlap )
- U ( Jaccard-type non-overlap )
- V ( Sorensen-type turnover )
- S ( Jaccard-type turnover )

```{r echo=FALSE}
data("beetle_abu")
data("beetle_inc")
data("beetle_tree")
data("beetle_distM")

# Taxonomic diversity
Abu_td_out = iNEXTBeta3D(data = beetle_abu, diversity = 'TD', datatype = "abundance",
                         nboot = 20)

Inc_td_out = iNEXTBeta3D(data = beetle_inc, diversity = 'TD', datatype = "incidence_raw",
                         nboot = 20)
# 
# 
# # Phylogenetic diversity
# Abu_pd_out = iNEXTBeta3D(data = beetle_abu, diversity = 'PD', datatype = "abundance", 
#                          nboot = 20, PDtree = tree)
# 
# Inc_pd_out = iNEXTBeta3D(data = beetle_inc, diversity = 'PD', datatype = "incidence_raw", 
#                          nboot = 20, PDtree = tree)
# 
# 
# # Functional diversity - single threshold
# Abu_fd_out = iNEXTBeta3D(data = beetle_abu, diversity = 'FD', datatype = "abundance",  nboot = 20,
#                          FDdistM = disM, FDtype = 'single', FDtau = 0.5)
# 
# Inc_fd_out = iNEXTBeta3D(data = beetle_inc, diversity = 'FD', datatype = "incidence_raw", nboot = 20,
#                          FDdistM = disM, FDtype = 'single', FDtau = 0.5)
# 
# 
# # Functional diversity - area under curve
# Abu_fd_out = iNEXTBeta3D(data = beetle_abu, diversity = 'FD', datatype = "abundance", nboot = 20,
#                          FDdistM = disM, FDtype = 'AUC')
# 
# Inc_fd_out = iNEXTBeta3D(data = beetle_inc, diversity = 'FD', datatype = "incidence_raw", nboot = 20,
#                          FDdistM = disM, FDtype = 'AUC')

head(Abu_td_out$`2008 vs. 2009 unlogged`$gamma)

```

```{r eval=FALSE}
head(Abu_td_out$`2008 vs. 2009 unlogged`$gamma)
```

```
  Estimate Order       Method Coverage_expected Coverage_real     Size      LCL      UCL                  Region
1 22.44478     0 Interpolated              0.80     0.7999993 3.188764 20.98240 23.90715 2015 vs. 2020 Exclosure
2 20.09673     1 Interpolated              0.80     0.7999993 3.188764 19.08284 21.11062 2015 vs. 2020 Exclosure
3 18.23929     2 Interpolated              0.80     0.7999993 3.188764 17.49593 18.98265 2015 vs. 2020 Exclosure
4 24.78115     0 Interpolated              0.85     0.8499996 4.109989 22.16489 27.39740 2015 vs. 2020 Exclosure
5 21.58071     1 Interpolated              0.85     0.8499996 4.109989 19.91455 23.24687 2015 vs. 2020 Exclosure
6 19.22455     2 Interpolated              0.85     0.8499996 4.109989 18.08024 20.36886 2015 vs. 2020 Exclosure

```

<p>



## GRAPHIC DISPLAYS: FUNCTION ggiNEXT_beta()

The function `ggiNEXT_beta()`, which extends `ggplot2` to the `"iNEXT_beta"` object with default arguments, is described as follows: 

```{r eval=FALSE}
ggiNEXTBeta3D(output, type = c("B", "D"), measurement = c("TD", "PD", "meanPD", "FD_tau", "FD_AUC"),
              scale = "free", main = NULL, transp = 0.4)  
```

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>output</code></td>
<td align="left">the output of <code>iNEXTBeta3D</code>.</td>

</tr>
<tr class="even">
<td align="center"><code>type</code></td>
<td align="left">selection of plot type : type = 'B' for plotting the gamma, alpha, and beta diversity ; type = 'D' for plotting 4 turnover dissimilarities.</td>

</tr>
<tr class="odd">
<td align="center"><code>measurement</code></td>
<td align="left">character indicating the label of y-axis.</td>

</tr>
<tr class="even">
<td align="center"><code>scale</code></td>
<td align="left">Are scales shared across all facets (<code>"fixed"</code>), or do they vary across rows (<code>"free_x"</code>), columns (<code>"free_y"</code>), or both rows and columns (<code>"free"</code>)? Default is <code>"free"</code>.</td>

</tr>
<tr class="odd">
<td align="center"><code>main</code></td>
<td align="left">The title of the plot./td>

</tr>
<tr class="even">
<td align="center"><code>transp</code></td>
<td align="left">a value between 0 and 1 controlling transparency. <code>transp = 0</code> is completely transparent, default is <code>0.4</code>.</td>


</tbody>
</table>



Users can visualize the output of beta diversity or four-class dissimilarities 
by setting the parameter <code>**type**</code> :

```{r, fig.align='center', fig.height=8, fig.width=8}
ggiNEXTBeta3D(Abu_td_out, type = 'B', measurement = "TD")
```

```{r,fig.align='center' , fig.height=8, fig.width=8}
ggiNEXTBeta3D(Abu_td_out, type = 'D', measurement = "FD_AUC")
```






